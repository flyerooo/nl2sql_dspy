# NL2SQL-IR: åŸºäºä¸­é—´è¡¨ç¤ºçš„é—®é¢˜åˆ°SQLè½¬æ¢

ä¸€ä¸ªä½¿ç”¨ä¸­é—´è¡¨ç¤º(Intermediate Representation, IR)æ¶æ„çš„ Text-to-SQL ç³»ç»Ÿ,ç»“åˆ DSPy æ¡†æ¶å®ç°ç¨³å¥çš„è‡ªç„¶è¯­è¨€åˆ° SQL æŸ¥è¯¢è½¬æ¢ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†ä½¿ç”¨](#è¯¦ç»†ä½¿ç”¨)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æµ‹è¯•](#æµ‹è¯•)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

## é¡¹ç›®æ¦‚è¿°

### ä¸ºä»€ä¹ˆä½¿ç”¨ IR æ¶æ„?

ç›´æ¥è®© LLM ç”Ÿæˆ SQL å­—ç¬¦ä¸²(Direct-to-SQL)è™½ç„¶ç®€å•,ä½†å­˜åœ¨è¯¸å¤šé—®é¢˜:
- âŒ å®¹æ˜“äº§ç”Ÿè¯­æ³•é”™è¯¯
- âŒ è¡¨å/åˆ—åå¹»è§‰
- âŒ éš¾ä»¥è°ƒè¯•å’Œç»´æŠ¤
- âŒ å­˜åœ¨ SQL æ³¨å…¥é£é™©

**IR æ¶æ„çš„ä¼˜åŠ¿:**
- âœ… ç»“æ„åŒ–ã€å¯éªŒè¯çš„è¾“å‡º
- âœ… è§£è€¦ LLM ç†è§£å’Œ SQL ç”Ÿæˆ
- âœ… æ”¯æŒè¯­ä¹‰å±‚æŠ½è±¡(è‡ªåŠ¨å¤„ç† JOIN)
- âœ… æ˜“äºè°ƒè¯•å’Œä¼˜åŒ–
- âœ… æ›´å¥½çš„å®‰å…¨æ€§

### æŠ€æœ¯æ ˆ

- **DSPy**: LLM ç¨‹åºæ¡†æ¶,æ”¯æŒç±»å‹åŒ–é¢„æµ‹å™¨å’Œè‡ªåŠ¨ä¼˜åŒ–
- **Pydantic**: æ•°æ®éªŒè¯å’Œç±»å‹æ£€æŸ¥
- **JSON5**: æ”¯æŒæ³¨é‡Šçš„é…ç½®æ–‡ä»¶æ ¼å¼

## æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªç„¶è¯­è¨€é—®é¢˜    â”‚
â”‚  "ä¸­å›½åŒºé”€å”®é¢   â”‚
â”‚   æœ€é«˜çš„5ä¸ªäº§å“" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: å€™é€‰å®ä½“æå–                  â”‚
â”‚ (SimpleCandidateExtractor)          â”‚
â”‚ - åŸºäºå…³é”®è¯åŒ¹é…ç­›é€‰ç›¸å…³å®ä½“         â”‚
â”‚ - å¯æ›¿æ¢ä¸ºæ›´å¤æ‚çš„è¯­ä¹‰æ£€ç´¢ç³»ç»Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: ç”Ÿæˆä¸­é—´è¡¨ç¤º (IR)            â”‚
â”‚ (ClauseDeconstructor + DSPy)        â”‚
â”‚ - ä¸‰é˜¶æ®µ LLM è°ƒç”¨                   â”‚
â”‚ - Pydantic ç±»å‹ä¿è¯                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IR (JSON ç»“æ„)                      â”‚
â”‚ {                                   â”‚
â”‚   "projections": [...],             â”‚
â”‚   "filters": {...},                 â”‚
â”‚   "group_by": [...],                â”‚
â”‚   ...                               â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: ç¼–è¯‘ä¸º SQL                   â”‚
â”‚ (SQLCompiler)                       â”‚
â”‚ - è‡ªåŠ¨è®¡ç®— JOIN è·¯å¾„                â”‚
â”‚ - ç”Ÿæˆå®Œæ•´ SQL                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQL æŸ¥è¯¢       â”‚
â”‚  SELECT ...     â”‚
â”‚  FROM ...       â”‚
â”‚  WHERE ...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
conda activate ml310
pip install dspy-ai pydantic json5
```

### 2. é…ç½® API å¯†é’¥

**å¿…é¡»é…ç½®**: è®¾ç½® Azure OpenAI API å¯†é’¥ç¯å¢ƒå˜é‡

```powershell
# Windows PowerShell
$env:AZURE_OPENAI_API_KEY="your-api-key-here"
```

è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒ [SETUP.md](SETUP.md)ã€‚

### 3. é…ç½® LLM

é¡¹ç›®é»˜è®¤ä½¿ç”¨ Azure OpenAIï¼Œé…ç½®å·²åœ¨ `src/llm_config.py` ä¸­å®Œæˆã€‚

å¦‚éœ€ä¿®æ”¹é…ç½®ï¼Œç¼–è¾‘ `src/llm_config.py`:

```python
def configure_azure_openai():
    # Azure OpenAI é…ç½®
    azure_endpoint = "..."
    deployment_name = "gpt-5"
    api_version = "2024-06-01"
    api_key = os.getenv("AZURE_OPENAI_API_KEY", "...")
    
    lm = dspy.LM(
        model=f"azure/{deployment_name}",
        api_base=azure_endpoint,
        api_version=api_version,
        api_key=api_key
    )
    dspy.configure(lm=lm)
    return lm
```

**ç”Ÿäº§ç¯å¢ƒæ¨è**: ä½¿ç”¨ç¯å¢ƒå˜é‡ `AZURE_OPENAI_API_KEY` å­˜å‚¨ API å¯†é’¥ã€‚

### 4. è¿è¡Œç¤ºä¾‹

```bash
cd src
python nl2sql_pipeline.py
```

### 5. è¿è¡Œæµ‹è¯•

```bash
cd tests
python test_pipeline.py
```

## è¯¦ç»†ä½¿ç”¨

### åŸºæœ¬ç”¨æ³•

```python
from nl2sql_pipeline import NL2SQLPipeline

# åˆå§‹åŒ–æµç¨‹
pipeline = NL2SQLPipeline()

# æ‰§è¡ŒæŸ¥è¯¢
result = pipeline.execute(
    question="æŸ¥è¯¢ä¸­å›½åŒºé”€å”®é¢æœ€é«˜çš„5ä¸ªäº§å“",
    return_ir=True,  # å¯é€‰:è¿”å›ä¸­é—´è¡¨ç¤º
    verbose=True     # å¯é€‰:æ‰“å°è¯¦ç»†æ—¥å¿—
)

print(result["sql"])
```

### è‡ªå®šä¹‰è¯­ä¹‰å±‚

ç¼–è¾‘ `entity_map.json5` æ¥å®šä¹‰ä½ çš„ä¸šåŠ¡å®ä½“:

```json5
{
  "entities": {
    "your_entity": {
      "table": "your_table",
      "column": "your_column",
      "type": "attribute"
    }
  },
  "foreign_keys": [
    {
      "from_table": "table_a",
      "from_column": "id",
      "to_table": "table_b",
      "to_column": "foreign_id"
    }
  ]
}
```

### é«˜çº§:è‡ªå®šä¹‰å€™é€‰æå–å™¨

å¯ä»¥æ›¿æ¢é»˜è®¤çš„ `SimpleCandidateExtractor` ä¸ºæ›´å¤æ‚çš„å®ç°:

```python
# å®ç°è‡ªå®šä¹‰æå–å™¨
class CustomCandidateExtractor:
    def extract_candidates(self, question: str) -> Dict[str, Any]:
        # ä½¿ç”¨å‘é‡æ£€ç´¢ã€LLMç­‰æ–¹æ³•æå–å€™é€‰å®ä½“
        return {
            "metrics": [...],
            "attributes": [...],
            "enum_values": {...}
        }

# ä½¿ç”¨è‡ªå®šä¹‰æå–å™¨
pipeline = NL2SQLPipeline(use_simple_extractor=False)
pipeline.candidate_extractor = CustomCandidateExtractor()
```

## é¡¹ç›®ç»“æ„

```
nl2sql_dspy/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ entity_map.json5             # è¯­ä¹‰å±‚é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ir_models.py             # IR æ•°æ®æ¨¡å‹ (Pydantic)
â”‚   â”œâ”€â”€ ir_parsers.py            # DSPy è§£æå™¨æ¨¡å—
â”‚   â”œâ”€â”€ text_to_ir.py            # Text-to-IR ä¸»æµç¨‹
â”‚   â”œâ”€â”€ sql_compiler.py          # SQL ç¼–è¯‘å™¨
â”‚   â”œâ”€â”€ nl2sql_pipeline.py       # ç«¯åˆ°ç«¯æµç¨‹
â”‚   â”œâ”€â”€ llm_config.py            # Azure OpenAI é…ç½®
â”‚   â””â”€â”€ readme.md                # æ¶æ„è¯´æ˜
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_pipeline.py         # ç«¯åˆ°ç«¯æµ‹è¯•
â””â”€â”€ data/
    â”œâ”€â”€ entity_map_example.json5
    â””â”€â”€ intermediate_representation.json5
```

## é…ç½®è¯´æ˜

### IR ç»“æ„æ”¯æŒçš„ SQL ç‰¹æ€§

âœ… **æ”¯æŒ:**
- SELECT åˆ—æŠ•å½±(ç®€å•åˆ—ã€èšåˆã€è®¡ç®—å­—æ®µ)
- WHERE è¿‡æ»¤(æ¯”è¾ƒã€INã€LIKEã€åµŒå¥— AND/OR)
- GROUP BY åˆ†ç»„
- HAVING èšåˆè¿‡æ»¤
- ORDER BY æ’åº
- LIMIT / OFFSET åˆ†é¡µ
- è‡ªåŠ¨ JOIN(åŸºäºå¤–é”®å…³ç³»)

âŒ **ä¸æ”¯æŒ(éœ€è¦æ‰©å±•):**
- å­æŸ¥è¯¢
- çª—å£å‡½æ•°
- CTE (WITH å­å¥)
- UNION / INTERSECT / EXCEPT
- CASE è¯­å¥

### è¯­ä¹‰å±‚é…ç½®

`entity_map.json5` åŒ…å«ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†:

1. **entities**: ä¸šåŠ¡å®ä½“åˆ°ç‰©ç†åˆ—çš„æ˜ å°„
   - `attribute`: ç®€å•åˆ—(å¯ç”¨äºè¿‡æ»¤ã€åˆ†ç»„)
   - `metric`: æŒ‡æ ‡(é€šå¸¸éœ€è¦èšåˆ)

2. **foreign_keys**: è¡¨ä¹‹é—´çš„å…³ç³»(ç”¨äºè‡ªåŠ¨ç”Ÿæˆ JOIN)

3. **enum_values**: å±æ€§çš„åˆæ³•å–å€¼(å¸®åŠ© LLM è§„èŒƒåŒ–å€¼)

## æµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
python tests/test_pipeline.py
```

### æµ‹è¯•è¦†ç›–

- âœ“ åŸºæœ¬æŸ¥è¯¢(SELECT, WHERE)
- âœ“ èšåˆæŸ¥è¯¢(COUNT, SUM, AVG, GROUP BY)
- âœ“ å¤æ‚æŸ¥è¯¢(å¤šæ¡ä»¶è¿‡æ»¤ã€æ’åºã€åˆ†é¡µ)
- âœ“ é”™è¯¯å¤„ç†(è¾¹ç•Œæƒ…å†µ)

## å€™é€‰å®ä½“æå–

### SimpleCandidateExtractor

é¡¹ç›®ä½¿ç”¨ `SimpleCandidateExtractor` è¿›è¡Œå€™é€‰å®ä½“æå–:

**å·¥ä½œåŸç†:**
- åŸºäºå…³é”®è¯æ¨¡ç³ŠåŒ¹é…ä» `entity_map.json5` ä¸­ç­›é€‰ç›¸å…³å®ä½“
- æ£€æŸ¥å®ä½“åç§°çš„å­ä¸²æ˜¯å¦å‡ºç°åœ¨ç”¨æˆ·é—®é¢˜ä¸­
- å¦‚æœåŒ¹é…æ•°é‡è¿‡å°‘,è¿”å›æ‰€æœ‰å€™é€‰å®ä½“

**ä¼˜ç‚¹:**
- ç®€å•å¿«é€Ÿ,æ— éœ€é¢å¤–ä¾èµ–
- é€‚åˆå¿«é€ŸåŸå‹å’Œä¸­å°è§„æ¨¡åº”ç”¨

**æ‰©å±•æ–¹å‘:**
- ä½¿ç”¨å‘é‡æ£€ç´¢è¿›è¡Œè¯­ä¹‰åŒ¹é…
- ç»“åˆ LLM ç†è§£é—®é¢˜æ„å›¾
- æ·»åŠ å®ä½“æ ‘ç»“æ„æ”¯æŒå±‚çº§å…³ç³»

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ“ä½œç¬¦

1. åœ¨ IR å®šä¹‰ä¸­æ·»åŠ æ–°çš„æ“ä½œç¬¦ç±»å‹(Pydantic æ¨¡å‹)
2. åœ¨ `sql_compiler.py` çš„ `_map_operator()` ä¸­æ·»åŠ æ˜ å°„
3. æ›´æ–°æ–‡æ¡£å’Œæµ‹è¯•

### ä¼˜åŒ– LLM æç¤º

ä½¿ç”¨ DSPy çš„ä¼˜åŒ–å™¨(å¦‚ `BootstrapFewShot`):

```python
from dspy.teleprompt import BootstrapFewShot

# å‡†å¤‡è®­ç»ƒæ•°æ®
trainset = [...]

# ä¼˜åŒ–
optimizer = BootstrapFewShot(metric=your_metric)
optimized_pipeline = optimizer.compile(
    pipeline.ir_generator,
    trainset=trainset
)
```

### æ‰©å±•è¯­ä¹‰å±‚

æ·»åŠ æ–°è¡¨æ—¶:
1. åœ¨ `entity_map.json5` ä¸­å®šä¹‰æ‰€æœ‰å®ä½“
2. æ·»åŠ å¿…è¦çš„ foreign_keys
3. æ›´æ–° enum_values
4. è¿è¡Œæµ‹è¯•éªŒè¯

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä½¿ç”¨ä¸‰é˜¶æ®µ LLM è°ƒç”¨?

A: åˆ†ç¦»èŒè´£å¯ä»¥æé«˜å‡†ç¡®æ€§:
- é˜¶æ®µ1: è§£æ„ä¸»è¦å­å¥(SELECT, GROUP BYç­‰)
- é˜¶æ®µ2: ä¸“æ³¨è§£æ WHERE æ¡ä»¶
- é˜¶æ®µ3: ä¸“æ³¨è§£æ HAVING æ¡ä»¶

### Q: å¦‚ä½•æé«˜å°æ¨¡å‹çš„æ€§èƒ½?

A: ä½¿ç”¨ DSPy çš„ few-shot ä¼˜åŒ–:
```python
from dspy.teleprompt import BootstrapFewShot
optimizer = BootstrapFewShot(metric=accuracy_metric)
optimized = optimizer.compile(module, trainset=examples)
```

### Q: æ”¯æŒå“ªäº›æ•°æ®åº“?

A: å½“å‰ç”Ÿæˆçš„ SQL æ˜¯é€šç”¨çš„ã€‚è¦æ”¯æŒç‰¹å®šæ•°æ®åº“æ–¹è¨€:
- ä¿®æ”¹ `sql_compiler.py` ä¸­çš„ `_build_limit_offset()`
- æ·»åŠ æ•°æ®åº“ç‰¹å®šçš„ç±»å‹è½¬æ¢

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request!

## è®¸å¯è¯

MIT License

## ç›¸å…³èµ„æº

- [DSPy æ–‡æ¡£](https://dspy-docs.vercel.app/)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
- [JSON5 è§„èŒƒ](https://json5.org/)

---

**ä½œè€…**: NL2SQL-IR Team  
**æœ€åæ›´æ–°**: 2025-11-04
